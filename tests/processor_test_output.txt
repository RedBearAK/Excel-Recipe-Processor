Testing concatenation calculations...
‚úì Created test data: 5 rows
‚úì Concatenation result: 5 rows, 8 columns
‚úì First concatenated ID: 'A001 - Widget A'
‚úì Concatenation worked correctly

Testing mathematical calculations...
‚úì Math calculation: 5 rows
‚úì First total value: 1050.0 (expected: 1050.0)
‚úì Mathematical calculation worked correctly

Testing conditional logic...
‚úì Conditional logic: 5 rows
‚úì High quantity items: 2
‚úì Low quantity items: 3
‚úì Conditional logic worked correctly

Testing date calculations...
‚úì Date calculation: 5 rows
‚úì First shipping days: 5
‚úì Date calculation worked correctly

Testing text operations...
‚úì Text operation: 5 rows
‚úì First name length: 8 (expected: 8)
‚úì Text operation worked correctly

Testing aggregation operations...
‚úì Aggregation: 5 rows
‚úì First total score: 263 (expected: 263)
‚úì Aggregation operation worked correctly

Testing expression calculations...
‚úì Expression calculation: 5 rows
‚úì First value per unit: 11.55 (expected: 11.55)
‚úì Expression calculation worked correctly

Testing column overwrite...
‚úì Overwrite test: 5 rows
‚úì Overwritten price: 1050.0 (expected: 1050.0)
‚úì Column overwrite worked correctly

Testing multiple calculations...
‚úì Multiple calculations: 5 rows, 9 columns
‚úì Both calculated columns created
‚úì First row: Total_Value=1050.0, Category='High Value'
‚úì Multiple calculations worked correctly

Testing error handling...
‚úì Caught expected error: Step 'Missing fields' missing required fields: new_column, calculation
‚úì Caught expected error: Column 'Price' already exists. Set 'overwrite: true' to replace it.
‚úì Caught expected error: Column 'NonExistentColumn' not found for math operation

‚úì All add calculated column processor tests passed!

Supported calculation types: ['expression', 'concat', 'conditional', 'math', 'date', 'text']
Supported conditions: ['equals', 'greater_than', 'less_than', 'contains', 'is_null', 'not_null']
Supported math operations: ['add', 'subtract', 'multiply', 'divide', 'sum', 'mean', 'min', 'max']
Testing basic subtotals...
‚úì Created sales data: 8 rows
‚úì Result: 11 rows (original + subtotals)
‚úì Added 3 subtotal rows for 3 regions
‚úì Subtotal calculations are correct

Testing hierarchical subtotals...
‚úì Created hierarchical data: 8 rows
‚úì Hierarchical result: 12 rows
‚úì Created hierarchical subtotals: 4 subtotal rows

Testing aggregation functions...
  ‚úì sum function worked correctly
  ‚úì count function worked correctly
  ‚úì mean function worked correctly
  ‚úì min function worked correctly
  ‚úì max function worked correctly
‚úì All aggregation functions worked correctly

Testing grand total preservation...
‚úì Created pivot result with grand total: 4 rows
‚úì Result with preserved totals: 7 rows
‚úì Grand totals preserved and subtotals added

Testing positioning options...
  Debug - after_group result:
    0: Region='East', Sales=180
    1: Region='East', Sales=120
    2: Region='East', Sales=90
    3: Region='After_Group Total: East', Sales=390
    4: Region='West', Sales=100
    5: Region='West', Sales=150
    6: Region='West', Sales=200
    7: Region='After_Group Total: West', Sales=450
  ‚úì after_group positioning worked correctly (2 subtotals)
  Debug - before_group result:
    0: Region='Before_Group Total: East', Sales=390
    1: Region='East', Sales=180
    2: Region='East', Sales=120
    3: Region='East', Sales=90
    4: Region='Before_Group Total: West', Sales=450
    5: Region='West', Sales=100
    6: Region='West', Sales=150
    7: Region='West', Sales=200
  ‚úì before_group positioning worked correctly (2 subtotals)
‚úì All positioning options worked correctly

Testing multiple columns with different functions...
‚úì Multi-function result: 11 rows
‚úì Multiple functions applied correctly

Testing real-world scenario...
‚úì Created realistic sales report: 8 rows
‚úì Report with subtotals: 12 rows
‚úì Territory-level subtotals found: 4 (expected: 4)
‚úì Unique territories in data: 4
‚úì Unique divisions in data: 2
‚úì Real-world scenario worked correctly

Testing utility functions...
‚úì SubtotalUtils.add_subtotals_to_dataframe worked correctly
‚úì SubtotalUtils.validate_subtotal_config worked correctly
‚úì SubtotalUtils.get_default_subtotal_config worked correctly

Testing edge cases...
‚úì Single row test: 2 rows
‚úì Missing values test: 5 rows
‚úì Edge cases handled correctly

Testing error handling...
‚úì Caught expected error: Step 'Missing group_by' missing required fields: group_by
‚úì Caught expected error: Group column 'NonExistentColumn' not found. Available columns: ['Region', 'Product', 'Sales', 'Quantity', 'Orders']
‚úì Caught expected error: Subtotal column 'NonExistentColumn' not found. Available columns: ['Region', 'Product', 'Sales', 'Quantity', 'Orders']
‚úì Caught expected error: Subtotal function 'invalid_function' not supported. Valid functions: ['sum', 'count', 'mean', 'min', 'max', 'nunique', 'std', 'var']
‚úì Caught expected error: Position 'invalid_position' not supported. Valid positions: ['before_group', 'after_group']

‚úì All add subtotals processor tests passed!

Supported functions: ['sum', 'count', 'mean', 'min', 'max', 'nunique', 'std', 'var']
Supported positions: ['before_group', 'after_group']
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Sales Summary' saved (undeclared): 4 rows, 2 columns - Regional sales totals
‚ö†Ô∏è Stage 'Sales Summary' loaded (undeclared): 4 rows, 2 columns [usage: 1]
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Aggregation Configs' loaded (undeclared): 3 rows, 5 columns [usage: 1]
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Region Lookup' loaded (undeclared): 4 rows, 5 columns [usage: 1]
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Test Overwrite Stage' saved (undeclared): 4 rows, 2 columns - Aggregated data from step 'Unnamed aggregate_data step'
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
‚ö†Ô∏è Stage 'Regional Quarterly Summary' saved (undeclared): 7 rows, 5 columns - Quarterly performance by region
‚ö†Ô∏è Stage 'Aggregation Configs' saved (undeclared): 3 rows, 5 columns - Test aggregation configurations
‚ö†Ô∏è Stage 'Region Lookup' saved (undeclared): 4 rows, 5 columns - Region lookup for aggregation configs
Testing AggregateDataProcessor refactoring...

=== Testing Basic Functionality (Regression) ===

Testing single column aggregation...
‚úì Single column aggregation: 8 rows ‚Üí 4 groups
‚úì Single column aggregation worked correctly

Testing multi-column aggregation...
‚úì Multi-column aggregation: 8 rows ‚Üí 6 groups
‚úì Multi-column aggregation created correctly

Testing multiple functions on same column...
‚úì Multiple functions: 4 groups
‚úì All aggregation functions applied correctly

Testing configuration options...
‚úì Without group columns: ['Total_Sales']
‚úì Configuration options worked correctly

=== Testing Stage-Based Aggregation (New Features) ===

Testing save to stage...
‚úì Save to stage worked correctly

Testing stage-based aggregation config...
‚úì Stage-based config: 4 groups
‚úì Stage-based aggregation config worked correctly

Testing lookup-based aggregation config...
‚úì Lookup-based config: 4 groups
‚úì Lookup-based aggregation config worked correctly

=== Testing File-Based Aggregation (New Features) ===

Testing file-based aggregation config...
‚úì File-based config: 4 groups
‚úì File-based aggregation config worked correctly

Testing variable substitution...
‚úì Variable substitution: 4 groups
‚úì Variable substitution worked correctly

=== Testing Helper Methods and Analysis ===

Testing summary aggregation helper...
‚úì Summary helper: 4 groups
‚úì Columns: ['Region', 'Sales_Amount_count', 'Sales_Amount_total', 'Sales_Amount_average', 'Sales_Amount_minimum', 'Sales_Amount_maximum', 'Order_Count_count', 'Order_Count_total', 'Order_Count_average', 'Order_Count_minimum', 'Order_Count_maximum']
‚úì Summary aggregation helper worked correctly

Testing analysis method...
‚úì Analysis results: dict_keys(['total_groups', 'group_columns', 'aggregated_columns', 'summary'])
‚úì Analysis method worked correctly

Testing enhanced capabilities method...
‚úì Capabilities: ['description', 'aggregation_functions', 'source_types', 'file_formats', 'grouping_features', 'output_features', 'helper_methods', 'integration_features']
‚úì Enhanced capabilities method worked correctly

=== Testing Error Handling and Compatibility ===

Testing aggregation error handling...
‚úì Caught expected error for missing stage: Aggregation config stage 'NonExistent Stage' not found. Available stages: ['Aggregation Configs', 'Region Lookup']
‚úì Caught expected error for invalid source type: Unsupported aggregation_source type: invalid_type
‚úì Caught expected error for stage overwrite: Failed to save aggregation results to stage 'Test Overwrite Stage': Stage 'Test Overwrite Stage' already exists. Use overwrite=true to replace it.
‚úì Error handling worked correctly

Testing real-world scenario...
‚úì Real-world scenario worked correctly

Testing backward compatibility...
‚úì Backward compatibility maintained

üéâ All AggregateDataProcessor refactoring tests passed!

Supported aggregation functions: ['sum', 'mean', 'median', 'min', 'max', 'count', 'nunique', 'std', 'var', 'first', 'last', 'size', 'sem', 'mad', 'prod', 'quantile']
Supported source types: ['inline', 'file', 'stage', 'lookup']
Supported file formats: ['xlsx', 'csv', 'tsv']
Integration features: ['stage_manager_integration', 'file_reader_integration', 'variable_substitution', 'configuration_from_external_sources']

To run with pytest: pytest test_aggregate_data_processor_refactored.py -v
Testing BaseStepProcessor...
‚úì Created processor: DummyProcessor(name='Test dummy step', processor_type='dummy_step')
‚úì Execution result: Processed: test data

Testing StepProcessorRegistry...
‚úì Registered dummy processor
‚úì Created processor from registry: DummyProcessor(name='Test dummy step', processor_type='dummy_step')
‚úì Registry processor result: Processed: registry test data
‚úì Available step types: ['dummy_step']

Testing error handling...
‚úì Caught expected error: Step configuration must be a dictionary
‚úì Caught expected error: Step configuration missing required 'processor_type' field
‚úì Caught expected error: Unknown step type: nonexistent_type. Available types: none

‚úì All tests passed!
Testing replace operations...
‚úì Created messy test data: 5 rows
Component column before replace: ['FLESH', 'flesh', 'FLESH', 'FLESH', 'FLESH']
‚úì Replace FLESH‚ÜíCANS: 0 FLESH remaining, 4 CANS found, 1 lowercase flesh
Component column after replace: ['CANS', 'flesh', 'CANS', 'CANS', 'CANS']
‚úì Case-sensitive replace worked correctly
‚úì Case-insensitive replace: 5 MEAT found

Testing text transformations...
‚úì Cleaned product name: 'CANNED BEANS'
‚úì Lowercased status: 'active'
‚úì Text transformations worked correctly

Testing numeric cleaning...
‚úì Price column dtype: float64
‚úì Sample prices: [10.5, 25.0, 15.75, 0.0, 12.0]
‚úì Numeric cleaning worked correctly

Testing fill empty values...
‚úì Null products remaining: 0
‚úì Null quantities remaining: 0
‚úì Fill empty values worked correctly

Testing regex operations...
‚úì Cleaned product (was 'CANNED CORN!'): 'CANNED CORN'
‚úì Regex operations worked correctly

Testing value standardization...
‚úì Standardized statuses: ['Active', 'Cancelled', 'Pending']
‚úì Value standardization worked correctly

Testing multiple cleaning rules...
‚úì Final product name: 'CANNED BEANS'
‚úì Final component: 'CANS'
‚úì Multiple rules applied correctly

Testing conditional replacement...
‚úì Created van report test data: 5 rows
Original data:
  CANNED BEANS: FLESH
  FRESH SALMON: FLESH
  CANNED CORN: FLESH
  DRIED FISH: FLESH
  canned soup: FLESH

After conditional replacement:
  CANNED BEANS: CANS
  FRESH SALMON: FLESH
  CANNED CORN: CANS
  DRIED FISH: FLESH
  canned soup: CANS

‚úì Results: 3 CANS, 2 FLESH
‚úì Conditional replacement worked correctly

Testing conditional replacement with equals...
Test data:
  Row 0: Status='Active', Notes='urgent'
  Row 1: Status='Inactive', Notes='normal'
  Row 2: Status='Active', Notes='urgent'
  Row 3: Status='Pending', Notes='normal'
  Row 4: Status='Active', Notes='urgent'
After conditional replacement:
  Row 0: Status='Active', Notes='PRIORITY'
  Row 1: Status='Inactive', Notes='normal'
  Row 2: Status='Active', Notes='PRIORITY'
  Row 3: Status='Pending', Notes='normal'
  Row 4: Status='Active', Notes='PRIORITY'
‚úì Priority notes: 3, Urgent remaining: 0
‚úì Conditional replacement with equals worked correctly

Testing conditional replacement with numeric conditions...
‚úì Premium items: 2, Standard items: 3
‚úì Conditional replacement with numeric condition worked correctly

Testing exact van report scenario...
‚úì Created exact van report scenario: 6 rows
Before processing:
  CANNED SALMON: FLESH
  FRESH HALIBUT: FLESH
  CANNED TUNA: FLESH
  FROZEN COD: FLESH
  CANNED SARDINES: FLESH
  FRESH SALMON: FLESH

After van report processing:
  CANNED SALMON: CANS
  FRESH HALIBUT: FLESH
  CANNED TUNA: CANS
  FROZEN COD: FLESH
  CANNED SARDINES: CANS
  FRESH SALMON: FLESH

‚úì Canned products with CANS: 3
‚úì Non-canned products with FLESH: 3
‚úì Van report exact scenario worked perfectly!

Testing remove invisible characters...
Before invisible char removal:
  Component 0: 'CANS\u200b'
  Component 1: 'FLESH\ufeff'
  Component 2: 'CANS\xa0'
  Component 3: '\u2000FLESH'
  Component 4: 'CANS\u200c\u200d'
After invisible char removal:
  Component 0: 'CANS'
  Component 1: 'FLESH'
  Component 2: 'CANS'
  Component 3: 'FLESH'
  Component 4: 'CANS'
‚úì Invisible character removal worked correctly

Testing normalize whitespace...
Before whitespace normalization:
  Row 0: Origin='  CORDOVA  ', Notes='Multiple   spaces   here'
  Row 1: Origin='NAKNEK\u200b\u200c', Notes='Line\nbreak\rhere'
  Row 2: Origin='DILLINGHAM\n\r', Notes='\u200bSome\u200ctext\ufeff'
  Row 3: Origin='FALSE\xa0PASS', Notes='  Clean this up  '
  Row 4: Origin='  KODIAK\t\t  ', Notes='Normal text'
After whitespace normalization:
  Row 0: Origin='CORDOVA', Notes='Multiple spaces here'
  Row 1: Origin='NAKNEK', Notes='Line break here'
  Row 2: Origin='DILLINGHAM', Notes='Sometext'
  Row 3: Origin='FALSE PASS', Notes='Clean this up'
  Row 4: Origin='KODIAK', Notes='Normal text'
‚úì Whitespace normalization worked correctly

Testing invisible chars breaking filtering scenario...
Before cleaning - simulating failed filters:
  'CANS' exact matches: 0 (should be 0 due to invisible chars)
  'SALMON' exact matches: 1 (should be 1)
After cleaning - filters should work:
  'CANS' exact matches: 2 (should be 2)
  'SALMON' exact matches: 3 (should be 3)
‚úì Invisible chars filtering fix worked correctly

Testing error handling...
‚úì Caught expected error: Step 'Missing rules' missing required fields: rules
‚úì Caught expected error: Error applying cleaning rule 1 in step 'Invalid column': Cleaning rule 1 column 'NonExistentColumn' not found. Available columns: ['Product_Name', 'Component', 'Price', 'Quantity', 'Date_Text', 'Status']
‚úì Caught expected error: Error applying cleaning rule 1 in step 'Invalid action': Cleaning rule 1 unknown action: 'invalid_action'. Available actions: replace, regex_replace, uppercase, lowercase, title_case, strip_whitespace, normalize_whitespace, remove_invisible_chars, remove_special_chars, fix_numeric, fix_dates, fill_empty, remove_duplicates, standardize_values

Testing conditional replacement error handling...
‚úì Caught expected error: Error applying cleaning rule 1 in step 'Missing condition column': Cleaning rule 1 has partial conditional replacement config. Missing required fields: ['condition_column']. For conditional replacement, all of ['condition_column', 'condition', 'condition_value'] are required.
‚úì Caught expected error: Error applying cleaning rule 1 in step 'Incomplete conditional config': Cleaning rule 1 has partial conditional replacement config. Missing required fields: ['condition', 'condition_value']. For conditional replacement, all of ['condition_column', 'condition', 'condition_value'] are required.

‚úì All clean data processor tests passed!

Supported actions: ['replace', 'regex_replace', 'uppercase', 'lowercase', 'title_case', 'strip_whitespace', 'normalize_whitespace', 'remove_invisible_chars', 'remove_special_chars', 'fix_numeric', 'fix_dates', 'fill_empty', 'remove_duplicates', 'standardize_values']
‚ö†Ô∏è Stage 'Report Title Section' saved (undeclared): 3 rows, 3 columns - Title section
‚ö†Ô∏è Stage 'Product Data Section' saved (undeclared): 3 rows, 3 columns - Data section
‚ö†Ô∏è Stage 'Report Title Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Data Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Report Title Section' saved (undeclared): 3 rows, 3 columns - Title section
‚ö†Ô∏è Stage 'Product Data Section' saved (undeclared): 3 rows, 3 columns - Data section
‚ö†Ô∏è Stage 'Report Title Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Data Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Data Section' saved (undeclared): 3 rows, 3 columns - Data section
‚ö†Ô∏è Stage 'Report Metadata Section' saved (undeclared): 3 rows, 2 columns - Metadata section
‚ö†Ô∏è Stage 'Product Data Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Report Metadata Section' loaded (undeclared): 3 rows, 2 columns [usage: 1]
‚ö†Ô∏è Stage 'Report Title Section' saved (undeclared): 3 rows, 3 columns - Title section
‚ö†Ô∏è Stage 'Product Data Section' saved (undeclared): 3 rows, 3 columns - Data section
‚ö†Ô∏è Stage 'Report Title Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Data Section' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Data Set 1' saved (undeclared): 3 rows, 3 columns - First data section
‚ö†Ô∏è Stage 'Product Data Set 2' saved (undeclared): 2 rows, 3 columns - Second data section
‚ö†Ô∏è Stage 'Product Data Set 1' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Data Set 2' loaded (undeclared): 2 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Report Title' saved (undeclared): 1 rows, 3 columns - Report title
‚ö†Ô∏è Stage 'Column Headers' saved (undeclared): 1 rows, 4 columns - Column headers
‚ö†Ô∏è Stage 'Sales Data' saved (undeclared): 3 rows, 4 columns - Sales data
‚ö†Ô∏è Stage 'Report Footer' saved (undeclared): 1 rows, 3 columns - Report footer
‚ö†Ô∏è Stage 'Report Title' loaded (undeclared): 1 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Column Headers' loaded (undeclared): 1 rows, 4 columns [usage: 1]
‚ö†Ô∏è Stage 'Sales Data' loaded (undeclared): 3 rows, 4 columns [usage: 1]
‚ö†Ô∏è Stage 'Report Footer' loaded (undeclared): 1 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Current Year Sales' saved (undeclared): 3 rows, 2 columns - Current year data
‚ö†Ô∏è Stage 'Previous Year Sales' saved (undeclared): 3 rows, 2 columns - Previous year data
‚ö†Ô∏è Stage 'Current Year Sales' loaded (undeclared): 3 rows, 2 columns [usage: 1]
‚ö†Ô∏è Stage 'Previous Year Sales' loaded (undeclared): 3 rows, 2 columns [usage: 1]
Testing Enhanced CombineDataProcessor...

Testing enhanced configuration validation...
‚úì Correctly caught missing column_handling
‚úì Correctly caught invalid column_handling
‚úì Correctly caught invalid retain_column_names type
‚úì Enhanced configuration validation tests passed

Testing require_matching_columns policy...
‚úì Correctly caught column mismatch with require_matching_columns

Testing allow_mismatched_columns policy...
‚úì Successfully combined mismatched columns: 6 total columns
‚úì Smart defaults correctly added headers: 8 rows

Testing explicit retain_column_names setting...
‚úì Headers correctly retained as first data row
‚úì Correct total row count with header retention: 8 rows

Testing smart defaults with allow_mismatched_columns...
‚úì Smart defaults correctly applied headers to both sections
‚úì Headers correctly preserved in both sections

Testing smart defaults with require_matching_columns...
‚úì Smart defaults correctly omitted headers for matching columns
‚úì No headers inserted with require_matching_columns smart default

Testing desktop publishing workflow...
‚úì Desktop publishing document assembled correctly
‚úì All document sections preserved with correct content

Testing horizontal concatenation with header retention...
‚úì Horizontal concatenation with headers completed correctly
‚úì Correct column count for horizontal combination: 5

Testing enhanced capabilities...
‚úì Column policies reported correctly
‚úì Desktop publishing example included

üéâ All Enhanced CombineDataProcessor tests passed!

To run with pytest: pytest test_enhanced_combine_data_processor.py -v
‚ö†Ô∏è Stage 'Approved Customers' saved (undeclared): 4 rows, 1 columns - List of customers approved for promotions
‚ö†Ô∏è Stage 'Approved Customers' loaded (undeclared): 4 rows, 1 columns [usage: 1]
‚ö†Ô∏è Stage 'Customer Tiers' saved (undeclared): 3 rows, 3 columns - Customer tier assignments
‚ö†Ô∏è Stage 'Customer Tiers' loaded (undeclared): 3 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Region Mapping' saved (undeclared): 4 rows, 2 columns - State to region mappings
‚ö†Ô∏è Stage 'Region Mapping' loaded (undeclared): 4 rows, 2 columns [usage: 1]
‚ö†Ô∏è Stage 'Test Overwrite' saved (undeclared): 3 rows, 1 columns
‚ö†Ô∏è Stage 'Test Overwrite' loaded (undeclared): 3 rows, 1 columns [usage: 1]
‚ö†Ô∏è Stage 'Test Overwrite' saved (undeclared): 4 rows, 1 columns
‚ö†Ô∏è Stage 'Test Overwrite' loaded (undeclared): 4 rows, 1 columns [usage: 1]
‚ö†Ô∏è Stage 'Metadata Test Stage' saved (undeclared): 3 rows, 1 columns - This is a test stage for metadata
Testing list format creation...
‚úì List format creation worked correctly

Testing table format creation...
‚úì Table format creation worked correctly

Testing dictionary format creation...
‚úì Dictionary format creation worked correctly

Testing size limits and warnings...
‚úì Size limit validation worked correctly
‚úì Table size limit validation worked correctly

Testing error handling...
‚úì Caught expected error for missing stage_name: Step 'Missing stage name' missing required fields: stage_name
‚úì Caught expected error for invalid format: Data format 'invalid_format' not supported. Valid formats: ['list', 'table', 'dictionary']
‚úì Caught expected error for reserved name: Failed to save stage 'current': Stage name 'current' is reserved. Please use a more descriptive name. Suggestions: ['Current']
‚úì Caught expected error for mismatched table: Table row 1 has 2 values but 3 columns defined
‚úì Error handling worked correctly

Testing overwrite behavior...
‚úì Correctly prevented overwrite: Failed to save stage 'Test Overwrite': Stage 'Test Overwrite' already exists. Use overwrite=true to replace it.
‚úì Overwrite behavior worked correctly

Testing metadata tracking...
‚úì Metadata tracking worked correctly

‚úì All create stage processor tests passed!

Supported formats: ['list', 'table', 'dictionary']
Size limits: {'list_items': 100, 'table_rows': 200, 'dictionary_entries': 150, 'warning_thresholds': {'list_items': 75, 'table_rows': 150, 'dictionary_entries': 112}}
üì§ Testing ExportFileProcessor functionality...
   Tests single/multi-sheet export, stage integration, variable substitution
   Leverages FileWriter for file operations and StageManager for stage access

Testing basic Excel export...
Traceback (most recent call last):
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/tests/test_export_file_processor.py", line 536, in <module>
    success &= test_basic_excel_export()
               ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/tests/test_export_file_processor.py", line 52, in test_basic_excel_export
    processor = ExportFileProcessor(step_config)
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/excel_recipe_processor/core/base_processor.py", line 387, in __init__
    raise StepProcessorError(f"Export step '{self.step_name}' requires source_stage")
excel_recipe_processor.core.base_processor.StepProcessorError: Export step 'Test Excel export' requires source_stage
Testing get_minimal_config...
‚úì get_minimal_config returned all required fields
Testing constant fill single column...
‚úì Created test data with 5 rows
Name column before fill: ['Alice', None, 'Charlie', 'David', None]
Name column after fill: ['Alice', 'Unknown', 'Charlie', 'David', 'Unknown']
‚úì Nulls before: 2, after: 0
‚úì Constant fill single column worked correctly

Testing constant fill multiple columns...
‚úì Created test data with 5 rows
Before fill:
  Name nulls: 2
  City nulls: 2
After fill:
  Name nulls: 0
  City nulls: 0
Name column: ['Alice', 'Unknown', 'Charlie', 'David', 'Unknown']
City column: ['New York', 'Boston', 'Unknown', 'Seattle', 'Unknown']
‚úì Constant fill multiple columns worked correctly

Testing forward fill...
Before forward fill: ['Alice', None, 'Charlie', 'David', None]
After forward fill: ['Alice', 'Alice', 'Charlie', 'David', 'David']
‚úì Forward fill worked correctly

Testing backward fill...
Before backward fill: ['Alice', None, 'Charlie', 'David', None]
After backward fill: ['Alice', 'Charlie', 'Charlie', 'David', None]
‚úì Backward fill worked correctly

Testing mean fill...
‚úì Mean fill worked correctly

Testing mode fill...
‚úì Mode fill worked correctly

Testing zero fill...
‚úì Zero fill worked correctly

Testing conditional fill...
‚úì Conditional fill worked correctly

Testing helper methods...
‚úì Helper methods worked correctly

Testing column not found error...
‚úì Correctly caught column not found error

Testing invalid fill method error...
‚úì Correctly caught invalid fill method error

‚úì All fill data processor tests passed!

Processor Capabilities:
  description: Fill missing/null values using various strategies similar to Excel fill operations
  fill_methods: constant, forward_fill, ffill, backward_fill, bfill, interpolate, mean, median, mode, replace, zero, empty_string
  condition_types: equals, not_equals, greater_than, less_than, contains, not_contains, is_null, not_null, in_list, not_in_list
  supported_features: constant_fill, forward_backward_fill, statistical_fill, conditional_fill, interpolation, replacement_fill, missing_data_analysis, limit_consecutive_fills
  helper_methods: fill_blanks_with_value, forward_fill_series, fill_with_statistical_value, analyze_missing_data
  excel_equivalents: {'fill_down': 'forward_fill method', 'fill_up': 'backward_fill method', 'fill_series': 'interpolate method', 'find_replace': 'replace method'}
  examples: {'basic_fill': "Fill null values with 'Unknown'", 'forward_fill': 'Carry forward last known value', 'conditional': 'Fill based on other column values'}
‚ö†Ô∏è Stage 'Approved Customers' saved (undeclared): 4 rows, 3 columns - List of approved customers for orders
‚ö†Ô∏è Stage 'Price History' saved (undeclared): 5 rows, 3 columns - Historical pricing data for products
‚ö†Ô∏è Stage 'Approved Customers' saved (undeclared): 4 rows, 3 columns - List of approved customers for orders
‚ö†Ô∏è Stage 'Price History' saved (undeclared): 5 rows, 3 columns - Historical pricing data for products
‚ö†Ô∏è Stage 'Approved Customers' loaded (undeclared): 4 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Approved Customers' saved (undeclared): 4 rows, 3 columns - List of approved customers for orders
‚ö†Ô∏è Stage 'Price History' saved (undeclared): 5 rows, 3 columns - Historical pricing data for products
‚ö†Ô∏è Stage 'Approved Customers' loaded (undeclared): 4 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Approved Customers' saved (undeclared): 4 rows, 3 columns - List of approved customers for orders
‚ö†Ô∏è Stage 'Price History' saved (undeclared): 5 rows, 3 columns - Historical pricing data for products
‚ö†Ô∏è Stage 'Price History' loaded (undeclared): 5 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Approved Customers' saved (undeclared): 4 rows, 3 columns - List of approved customers for orders
‚ö†Ô∏è Stage 'Price History' saved (undeclared): 5 rows, 3 columns - Historical pricing data for products
‚ö†Ô∏è Stage 'Approved Customers' loaded (undeclared): 4 rows, 3 columns [usage: 1]
‚ö†Ô∏è Stage 'Test Stage' saved (undeclared): 3 rows, 2 columns - Test stage for error handling
Testing FilterDataProcessor refactoring...

=== Testing Basic Functionality (Regression) ===

Testing basic equals filter...
‚úì Basic equals filter works correctly

Testing multiple filters...
‚úì Multiple filters work correctly

Testing numeric conditions...
‚úì Numeric conditions work correctly

Testing list conditions...
‚úì List conditions work correctly

=== Testing Stage-Based Filtering (New Features) ===

Testing in_stage filter...
‚úì in_stage filter works correctly

Testing not_in_stage filter...
‚úì not_in_stage filter works correctly

Testing stage_comparison filter...
‚úì stage_comparison filter works correctly

Testing combined stage and basic filters...
‚úì Combined stage and basic filters work correctly

=== Testing Error Handling and Capabilities ===

Testing stage filter error handling...
‚úì Caught expected error for missing stage_name
‚úì Caught expected error for nonexistent stage
‚úì Error handling works correctly

Testing capabilities reporting...
‚úì Capabilities include stage integration features

Testing backward compatibility...
‚úì Backward compatibility maintained

üéâ All FilterDataProcessor refactoring tests passed!

Supported conditions: ['equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'greater_equal', 'less_equal', 'not_empty', 'is_empty', 'in_list', 'not_in_list', 'in_stage', 'not_in_stage', 'stage_comparison']
Stage-based conditions: ['in_stage', 'not_in_stage', 'stage_comparison']

To run with pytest: pytest test_filter_data_processor_refactored.py -v
Testing openpyxl requirement...
‚úì openpyxl is available for testing

Testing basic formatting...
‚úì Basic formatting worked correctly

Testing freeze panes...
‚úì Freeze panes formatting worked correctly

Testing multiple sheets...
‚úì Multiple sheets formatting worked correctly

Testing column and row sizing...
‚úì Column and row sizing worked correctly

Testing auto-filter...
‚úì Auto-filter formatting worked correctly

Testing error handling...
‚úì Caught expected error for missing target_file: Step 'Missing target file' missing required fields: target_file
‚úì Caught expected error for nonexistent file: Target file not found: /nonexistent/file.xlsx
‚úì Caught expected error for invalid extension: Target file must be Excel format (.xlsx or .xls), got: .txt
‚úì Caught expected error for invalid column width: 'max_column_width' must be a positive number
‚úì Error handling worked correctly

Testing variable substitution...
‚úì Variable substitution interface worked correctly

Testing real variable substitution...
‚úì Real variable substitution worked correctly

Testing data passthrough...
‚úì Data passthrough worked correctly

‚úì All format Excel processor tests passed!

Supported features: ['auto_fit_columns', 'column_widths', 'header_bold', 'header_background', 'freeze_panes', 'freeze_top_row', 'row_heights', 'auto_filter', 'active_sheet']
Processor capabilities: ['description', 'formatting_features', 'formatting_categories', 'file_requirements', 'dependencies', 'examples']
‚ö†Ô∏è Stage 'basic_import_stage' saved (undeclared): 4 rows, 4 columns - Imported from Test Excel import
üì• Testing ImportFileProcessor functionality...
   Tests basic import, stage saving, variable substitution, and error handling
   Leverages FileReader for file operations and StageManager for stage operations

Testing basic Excel import...
‚úì Imported data: (4, 4)
‚úì Result columns: ['ProductID', 'ProductName', 'Category', 'Price']
‚úì Basic Excel import worked correctly

Testing basic CSV import...
Traceback (most recent call last):
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/tests/test_import_file_processor.py", line 541, in <module>
    success &= test_basic_import_csv()
               ~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/tests/test_import_file_processor.py", line 118, in test_basic_import_csv
    result = processor.execute(original_data)
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/excel_recipe_processor/core/base_processor.py", line 345, in execute
    return self.execute_import()
           ~~~~~~~~~~~~~~~~~~~^^
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/excel_recipe_processor/core/base_processor.py", line 355, in execute_import
    self.save_output_data(data)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/excel_recipe_processor/core/base_processor.py", line 363, in save_output_data
    StageManager.save_stage(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        stage_name=self.save_to_stage,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
        confirm_replacement=self.confirm_stage_replacement
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/home/kris/Documents/Dev-Projects/Excel-Recipe-Processor/excel_recipe_processor/core/stage_manager.py", line 196, in save_stage
    raise StageError(
        f"Stage '{stage_name}' already exists. Use overwrite=true to replace it."
    )
excel_recipe_processor.core.stage_manager.StageError: Stage 'basic_import_stage' already exists. Use overwrite=true to replace it.
‚ö†Ô∏è Stage 'Customer Data' saved (undeclared): 4 rows, 4 columns - Customer master data
‚ö†Ô∏è Stage 'Customer Data' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Replacing current data (3 rows) with stage 'Customer Data' (4 rows)
‚ö†Ô∏è Stage 'Safety Test Stage' saved (undeclared): 4 rows, 4 columns - Test data for safety
‚ö†Ô∏è Stage 'Safety Test Stage' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Replacing current data (3 rows) with stage 'Safety Test Stage' (4 rows)
‚ö†Ô∏è Stage 'Usage Test Stage' saved (undeclared): 4 rows, 4 columns - Test data for usage tracking
‚ö†Ô∏è Stage 'Usage Test Stage' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Replacing current data (3 rows) with stage 'Usage Test Stage' (4 rows)
‚ö†Ô∏è Stage 'Multi Load Test' saved (undeclared): 4 rows, 4 columns - Test data for multiple loads
‚ö†Ô∏è Stage 'Multi Load Test' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Replacing current data (3 rows) with stage 'Multi Load Test' (4 rows)
‚ö†Ô∏è Stage 'Multi Load Test' loaded (undeclared): 4 rows, 4 columns [usage: 2]
Replacing current data (3 rows) with stage 'Multi Load Test' (4 rows)
‚ö†Ô∏è Stage 'Multi Load Test' loaded (undeclared): 4 rows, 4 columns [usage: 3]
Replacing current data (3 rows) with stage 'Multi Load Test' (4 rows)
‚ö†Ô∏è Stage 'Isolation Test' saved (undeclared): 4 rows, 4 columns - Test data for isolation
‚ö†Ô∏è Stage 'Isolation Test' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Replacing current data (3 rows) with stage 'Isolation Test' (4 rows)
‚ö†Ô∏è Stage 'Isolation Test' loaded (undeclared): 4 rows, 4 columns [usage: 2]
‚ö†Ô∏è Stage 'Original Orders' saved (undeclared): 3 rows, 3 columns - Original order data before processing
‚ö†Ô∏è Stage 'Processed Orders' saved (undeclared): 3 rows, 4 columns - Orders with 10% markup added
‚ö†Ô∏è Stage 'Original Orders' loaded (undeclared): 3 rows, 3 columns [usage: 1]
Replacing current data (3 rows) with stage 'Original Orders' (3 rows)
Testing basic load functionality...
‚úì Basic load functionality worked correctly

Testing confirm_replace safety...
‚úì Correctly enforced confirm_replace safety: Step 'Unnamed load_stage step' missing required fields: confirm_replace
‚úì Correctly rejected confirm_replace=false: 'confirm_replace' must be set to true to acknowledge that current data will be replaced
‚úì confirm_replace safety mechanism worked correctly

Testing usage tracking...
‚úì Usage tracking worked correctly

Testing multiple loads...
‚úì Multiple loads worked correctly

Testing error handling...
‚úì Caught expected error for missing stage_name: Step 'Missing stage name' missing required fields: stage_name
‚úì Caught expected error for nonexistent stage: Error loading stage in step 'Unnamed load_stage step': Stage 'Nonexistent Stage' not found. No stages have been created yet.
üí° Make sure an import_file or processing step created this stage first.
‚úì Caught expected error for invalid stage_name type: Error loading stage in step 'Unnamed load_stage step': Stage '123' not found. No stages have been created yet.
üí° Make sure an import_file or processing step created this stage first.
‚úì Error handling worked correctly

Testing data isolation...
‚úì Data isolation worked correctly

Testing workflow scenario...
‚úì Workflow scenario worked correctly

‚úì All load stage processor tests passed!

Processor capabilities: ['description', 'stage_features', 'safety_features', 'examples']
‚ö†Ô∏è Stage 'Customer Master' saved (undeclared): 5 rows, 5 columns - Customer master data for lookups
‚ö†Ô∏è Stage 'Product Catalog' saved (undeclared): 5 rows, 5 columns - Product catalog for lookups
‚ö†Ô∏è Stage 'Territory Data' saved (undeclared): 4 rows, 4 columns - Territory and sales data
‚ö†Ô∏è Stage 'Customer Master' saved (undeclared): 5 rows, 5 columns - Customer master data for lookups
‚ö†Ô∏è Stage 'Product Catalog' saved (undeclared): 5 rows, 5 columns - Product catalog for lookups
‚ö†Ô∏è Stage 'Territory Data' saved (undeclared): 4 rows, 4 columns - Territory and sales data
‚ö†Ô∏è Stage 'Customer Master' loaded (undeclared): 5 rows, 5 columns [usage: 1]
‚ö†Ô∏è Stage 'Customer Master' saved (undeclared): 5 rows, 5 columns - Customer master data for lookups
‚ö†Ô∏è Stage 'Product Catalog' saved (undeclared): 5 rows, 5 columns - Product catalog for lookups
‚ö†Ô∏è Stage 'Territory Data' saved (undeclared): 4 rows, 4 columns - Territory and sales data
‚ö†Ô∏è Stage 'Customer Master' loaded (undeclared): 5 rows, 5 columns [usage: 1]
‚ö†Ô∏è Stage 'Territory Data' loaded (undeclared): 4 rows, 4 columns [usage: 1]
‚ö†Ô∏è Stage 'Customer Master' saved (undeclared): 5 rows, 5 columns - Customer master data for lookups
‚ö†Ô∏è Stage 'Product Catalog' saved (undeclared): 5 rows, 5 columns - Product catalog for lookups
‚ö†Ô∏è Stage 'Territory Data' saved (undeclared): 4 rows, 4 columns - Territory and sales data
‚ö†Ô∏è Stage 'Customer Master' loaded (undeclared): 5 rows, 5 columns [usage: 1]
‚ö†Ô∏è Stage 'Product Catalog' loaded (undeclared): 5 rows, 5 columns [usage: 1]
‚ö†Ô∏è Stage 'Territory Data' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Testing LookupDataProcessor refactoring...

=== Testing Basic Functionality (Regression) ===

Testing basic inline lookup...
‚úì Basic inline lookup works correctly

Testing DataFrame lookup...
‚úì DataFrame lookup works correctly

Testing multiple column lookup...
‚úì Multiple column lookup works correctly

Testing different join types...
‚úì Join types work correctly

=== Testing File-Based Lookups (FileReader Integration) ===

Testing file-based lookup...
‚úì File-based lookup works correctly

Testing variable substitution in file lookup...
‚úì Variable substitution lookup works correctly

=== Testing Stage-Based Lookups (StageManager Integration) ===

Testing stage-based lookup...
‚úì Stage-based lookup works correctly

Testing chained stage lookups...
‚úì Chained stage lookups work correctly

Testing real-world scenario...
‚úì Real-world scenario works correctly

=== Testing Advanced Features ===

Testing case insensitive lookup...
‚úì Case insensitive lookup works correctly

Testing prefix/suffix naming...
‚úì Prefix/suffix naming works correctly

Testing default values...
‚úì Default values work correctly

Testing duplicate handling...
‚úì Duplicate handling works correctly

=== Testing Error Handling and Capabilities ===

Testing lookup error handling...
‚úì Caught expected error for missing lookup_source
‚úì Caught expected error for nonexistent stage
‚úì Caught expected error for invalid source key
‚úì Error handling works correctly

Testing capabilities and configuration...
‚úì Capabilities and configuration work correctly

üéâ All LookupDataProcessor refactoring tests passed!

Supported join types: ['left', 'right', 'inner', 'outer']
Supported duplicate handling: ['first', 'last', 'error']
Supported source types: ['file', 'stage', 'inline', 'dataframe']

To run with pytest: pytest test_lookup_data_processor_refactored.py -v
‚ö†Ô∏è Stage 'Test Customer Data' saved (undeclared): 4 rows, 4 columns - Customer data for merge testing
‚ö†Ô∏è Stage 'Test Customer Data' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Testing dictionary merge...
‚úì Created orders data: 5 rows
‚úì Merge result: 5 rows, 8 columns
‚úì Result columns: ['Order_ID', 'Customer_ID', 'Product_Code', 'Quantity', 'Order_Date', 'key', 'Customer_Name', 'Region']
‚úì Dictionary merge worked correctly

Testing different join types...
‚úì left join: 4 rows (All left rows preserved)
  ‚úì left join worked correctly
‚úì inner join: 2 rows (Only matching rows)
  ‚úì inner join worked correctly
‚úì outer join: 5 rows (All rows from both sides)
  ‚úì outer join worked correctly

Testing CSV file merge...
‚úì CSV merge result: 5 rows, 8 columns
‚úì CSV file merge worked correctly

Testing Excel file merge...
‚úì Excel merge result: 5 rows, 8 columns
‚úì Excel file merge worked correctly

Testing column conflict handling...
‚úì Conflict handling result columns: ['ID', 'Name_left', 'Value_left', 'key', 'Name_right', 'Value_right', 'Extra']
‚úì Column conflict handling worked correctly

Testing real-world scenario...
‚úì Orders data: 5 rows
‚úì After customer merge: 5 rows, 9 columns
‚úì Final enriched data: 5 rows, 11 columns
‚úì Final columns: ['Order_ID', 'Customer_ID', 'Product_SKU', 'Quantity', 'Unit_Price', 'key_x', 'Customer_Name', 'Region', 'Tier', 'Product_Name', 'Category']
‚úì Real-world scenario worked correctly

Testing merge statistics...
‚úì Statistics test result: 5 rows
‚úì Customers matched: 3/5
‚úì Merge statistics test worked correctly

Testing stage merge...
‚úì Stage merge result: 5 rows, 8 columns
‚úì Stage merge worked correctly

Testing stage merge error handling...
‚úì Caught expected error for missing stage: Merge stage 'NonExistent Stage' not found. Available stages: []
‚úì Caught expected error for missing stage_name: Stage merge source requires 'stage_name' field
‚úì Stage merge error handling worked correctly

Testing error handling...
‚úì Caught expected error: Step 'Missing merge source' missing required fields: merge_source
‚úì Caught expected error: Left key column 'NonExistentColumn' not found. Available columns: ['Order_ID', 'Customer_ID', 'Product_Code', 'Quantity', 'Order_Date']
‚úì Caught expected error: join_type 'invalid_join' not supported. Valid types: ['left', 'right', 'inner', 'outer']
‚úì Caught expected error: Error reading merge file '/nonexistent/file.csv': File not found: /nonexistent/file.csv

‚úì All merge data processor tests passed!

Supported join types: ['left', 'right', 'inner', 'outer']
Supported source types: ['excel', 'csv', 'tsv', 'dictionary', 'stage']
Testing basic pivot table...
‚úì Created test data: 12 rows
‚úì Basic pivot: 8 rows, 2 columns
‚úì Columns: ['Product_Origin', 'Quantity']
‚úì Basic pivot table created correctly
Sample results:
  Cordova: 200
  Craig: 140
  Dillingham: 90

Testing van report style pivot...
‚úì Van report pivot: 11 rows, 5 columns
‚úì Van report style pivot created correctly

Testing origin vs carrier matrix...
‚úì Matrix pivot: 8 rows, 4 columns
‚úì Columns: ['Product_Origin', 'Quantity_Carrier_A', 'Quantity_Carrier_B', 'Quantity_Carrier_C']
‚úì Origin vs Carrier matrix created correctly
Sample matrix:
  {'Product_Origin': 'Cordova', 'Quantity_Carrier_A': 1, 'Quantity_Carrier_B': 0, 'Quantity_Carrier_C': 0}
  {'Product_Origin': 'Craig', 'Quantity_Carrier_A': 0, 'Quantity_Carrier_B': 1, 'Quantity_Carrier_C': 0}
  {'Product_Origin': 'Dillingham', 'Quantity_Carrier_A': 1, 'Quantity_Carrier_B': 0, 'Quantity_Carrier_C': 0}

Testing multiple aggregation functions...
‚úì Sum of quantities: 3 rows
‚úì Average quantities: 3 rows
‚úì Count of records: 3 rows
‚úì Maximum quantities: 3 rows
‚úì Minimum quantities: 3 rows

Testing count pivot without values...
‚úì Count pivot: 8 rows, 13 columns
‚úì Count pivot created correctly

Testing fill blanks option...
‚úì Fill blanks pivot: 8 rows
‚úì Null values in first column: 0
‚úì Fill blanks worked correctly

Testing cross-tabulation...
‚úì Cross-tab: 8 rows, 4 columns
‚úì Cross-tabulation created correctly

Testing pivot info analysis...
‚úì Pivot info analysis:
  Total rows: 12
  Total columns: 6
  Numeric columns: ['Quantity', 'Value']
  Categorical columns: ['Product_Origin', 'Van_Number', 'Carrier', 'Destination']
  Column cardinality: {'Product_Origin': 8, 'Van_Number': 10, 'Carrier': 3, 'Destination': 3}
‚úì Pivot info analysis worked correctly

Testing error handling...
‚úì Caught expected error: Index field 'NonExistentColumn' not found in data columns
‚úì Caught expected error: Value field 'NonExistentColumn' not found in data columns
‚úì Caught expected error: Unknown aggregation function: 'invalid_function'. Valid options: sum, mean, count, min, max, std, var, first, last, nunique

‚úì All pivot table processor tests passed!

Supported aggregation functions: ['sum', 'mean', 'count', 'min', 'max', 'std', 'var', 'first', 'last', 'nunique']
Testing mapping rename...
‚úì Created test data with columns: ['Product Code', 'Product Name!', 'PRICE USD', 'qty_in_stock', ' Department ', 'Order-Date']
‚úì Renamed columns: ['product_code', 'product_name', 'price_usd', 'quantity', ' Department ', 'Order-Date']
‚úì Mapping rename worked correctly

Testing pattern rename...
‚úì Created data with columns: ['col_2024_jan', 'col_2024_feb', 'col_2024_mar', 'other_column']
‚úì Pattern renamed columns: ['2024_jan', '2024_feb', '2024_mar', 'other_column']
‚úì Pattern rename worked correctly

Testing transform rename...
‚úì Created data with columns: ['Product Code', 'Product Name!', 'PRICE USD', 'qty_in_stock', ' Department ', 'Order-Date']
‚úì Transformed columns: ['product_code', 'product_name', 'price_usd', 'qty_in_stock', 'department', 'order_date']
‚úì Transform rename worked correctly

Testing case conversions...
‚úì upper: ['PRODUCT NAME', 'PRICE USD', 'QTY-IN-STOCK']
  ‚úì upper conversion worked correctly
‚úì lower: ['product name', 'price usd', 'qty-in-stock']
  ‚úì lower conversion worked correctly
‚úì title: ['Product Name', 'Price Usd', 'Qty-In-Stock']
  ‚úì title conversion worked correctly
‚úì snake_case: ['product_name', 'price_usd', 'qty_in_stock']
  ‚úì snake_case conversion worked correctly
‚úì camel_case: ['productName', 'priceUsd', 'qtyInStock']
  ‚úì camel_case conversion worked correctly

Testing prefix and suffix...
‚úì Prefix/suffix result: ['col_step_description_data', 'col_price_data', 'col_quantity_data']
‚úó Expected ['col_name_data', 'col_price_data', 'col_quantity_data'], got ['col_step_description_data', 'col_price_data', 'col_quantity_data']

Testing standardize helper...
‚úì Messy columns: ['Product Name!', 'PRICE (USD)', ' Department ', 'Order-Date']
‚úì Standardized columns: ['product_name', 'price_usd', 'department', 'order_date']
‚úì Standardize helper worked correctly

Testing column analysis...
‚úì Analysis results:
  Total columns: 6
  Issues found: 11
  Recommendations: 3
‚úì Column analysis worked correctly

Testing duplicate name detection...
‚úì Caught expected error: Duplicate new column names not allowed: ['new_name', 'new_name']

Testing real-world scenario...
‚úì Messy export columns: ['Prod Code', 'Product Name (English)', 'Price $USD', 'QTY ON HAND', 'Last Modified Date', 'Category/Type']
‚úì Cleaned columns: ['prod_code', 'product_name_english', 'price_usd', 'qty_on_hand', 'last_modified_date', 'category_type']
‚úì Real-world scenario worked correctly

Testing error handling...
‚úì Caught expected error: Columns not found for renaming: ['NonExistentColumn']. Available columns: ['Product Code', 'Product Name!', 'PRICE USD', 'qty_in_stock', ' Department ', 'Order-Date']
‚úì Caught expected error: 'mapping' dictionary cannot be empty for mapping type
‚úì Caught expected error: Invalid regex pattern '[invalid regex': unterminated character set at position 0

‚úó Some rename columns processor tests failed!

Supported rename types: ['mapping', 'pattern', 'transform']
Supported case conversions: ['upper', 'lower', 'title', 'snake_case', 'camel_case']
‚ö†Ô∏è Stage 'Customer Master Data' saved (undeclared): 4 rows, 4 columns - Complete customer information for analysis
‚ö†Ô∏è Stage 'Customer Master Data' loaded (undeclared): 4 rows, 4 columns [usage: 1]
‚ö†Ô∏è Stage 'Test Overwrite Stage' saved (undeclared): 4 rows, 4 columns - Initial data
‚ö†Ô∏è Stage 'Test Overwrite Stage' loaded (undeclared): 4 rows, 4 columns [usage: 1]
‚ö†Ô∏è Stage 'Test Overwrite Stage' saved (undeclared): 2 rows, 2 columns - Overwritten data
‚ö†Ô∏è Stage 'Test Overwrite Stage' loaded (undeclared): 2 rows, 2 columns [usage: 1]
‚ö†Ô∏è Stage 'Metadata Test Stage' saved (undeclared): 4 rows, 4 columns - Stage created for testing metadata tracking
‚ö†Ô∏è Stage 'Customer Data' saved (undeclared): 4 rows, 4 columns - Customer master data
‚ö†Ô∏è Stage 'Product Catalog' saved (undeclared): 3 rows, 3 columns - Product master data
‚ö†Ô∏è Stage 'Stage 1' saved (undeclared): 4 rows, 4 columns
‚ö†Ô∏è Stage 'Stage 2' saved (undeclared): 4 rows, 4 columns
‚ö†Ô∏è Stage 'Isolation Test' saved (undeclared): 4 rows, 4 columns
‚ö†Ô∏è Stage 'Isolation Test' loaded (undeclared): 4 rows, 4 columns [usage: 1]
Testing basic save functionality...
‚úì Basic save functionality worked correctly

Testing overwrite behavior...
‚úì Correctly prevented overwrite: Error saving stage in step 'Unnamed save_stage step': Stage 'Test Overwrite Stage' already exists. Use overwrite=true to replace it.
‚úì Overwrite behavior worked correctly

Testing metadata tracking...
‚úì Metadata tracking worked correctly

Testing multiple stages...
‚úì Multiple stages saved correctly

Testing error handling...
‚úì Caught expected error for missing stage_name: Step 'Missing stage name' missing required fields: stage_name
‚úì Caught expected error for reserved name: Error saving stage in step 'Unnamed save_stage step': Stage name 'input' is reserved. Please use a more descriptive name. Suggestions: ['Input']
‚úì Empty DataFrame properly rejected
‚úì Error handling worked correctly

Testing stage limit enforcement...
‚úì Stage limit enforcement worked correctly

Testing data isolation...
‚úì Data isolation worked correctly

‚úì All save stage processor tests passed!

Processor capabilities: ['description', 'stage_features', 'safety_features', 'examples']
‚ö†Ô∏è Stage 'Test Data' saved (undeclared): 11 rows, 4 columns - Test data for slicing
‚ö†Ô∏è Stage 'Test Data' loaded (undeclared): 11 rows, 4 columns [usage: 1]
Testing SliceDataProcessor...
Testing basic row slicing...
‚úì Row slicing returned correct number of rows
‚úì Row slicing extracted correct content

Testing data section extraction with header promotion...
‚úì Data extraction returned correct number of rows
‚úì Headers promoted correctly
‚úì Data content preserved correctly

Testing slice without header promotion...
‚úì Slice without headers returned correct number of rows
‚úì Generic column names preserved (headers not promoted)

Testing column slicing...
‚úì Column slicing returned correct number of columns
‚úì Column slicing preserved all rows

Testing Excel column references...
‚úì Excel column references work correctly

Testing stage integration...
‚úì Stage integration works correctly

Testing error handling...
‚úì Caught expected error for invalid start_row: StepProcessorError
‚úì Caught expected error for start_row beyond data: StepProcessorError
‚úì Error handling works correctly

Testing capabilities...
‚úì Capabilities include slice operations
‚úì Supported slice types reported correctly

üéâ All SliceDataProcessor tests passed!

To run with pytest: pytest test_slice_data_processor.py -v
Testing single column sort...
‚úì Created test data: 5 rows
‚úì Single column sort: 5 rows
‚úì Sorted prices: [8.25, 10.5, 12.0, 15.75, 25.0]
‚úì Single column sort worked correctly

Testing multi-column sort...
‚úì Multi-column sort: 5 rows
Sorted data:
  Electronics: $10.5
  Electronics: $8.25
  Hardware: $25.0
  Tools: $15.75
  Tools: $12.0
‚úì Multi-column sort worked correctly

Testing custom sort order...
‚úì Custom sort: 5 rows
‚úì Priority order: ['High', 'High', 'Medium', 'Low', 'Low']
‚úì Custom sort order worked correctly

Testing case-insensitive sort...
‚úì Case insensitive sort: 5 rows
‚úì Sorted names: ['widget a', 'Widget A', 'Widget B', 'Widget C', 'widget d']
‚úì Case-insensitive sort worked correctly

Testing null position handling...
‚úì Nulls last: ['Alice', 'Bob', 'Charlie', None, None]
‚úì Nulls first: [None, None, 'Alice', 'Bob', 'Charlie']
‚úì Null position handling worked correctly

Testing frequency sort...
‚úì Frequency sort: 5 rows
‚úì Department frequency order: ['Electronics', 'Electronics', 'Tools', 'Tools', 'Hardware']
‚úì Department counts: {'Electronics': 2, 'Tools': 2, 'Hardware': 1}
‚úì Frequency sort worked correctly

Testing multiple criteria sort...
‚úì Multiple criteria sort: 5 rows
Results:
  High: Widget C
  High: widget d
  Medium: Widget B
  Low: widget a
  Low: Widget A
‚úì Multiple criteria sort worked correctly

Testing sort analysis...
‚úì Price analysis:
  Data type: float64
  Min/Max: 8.25/25.0
  Already sorted: False
‚úì Product name analysis:
  Data type: object
  Avg length: 8.0
  Already sorted: False
‚úì Sort analysis worked correctly

Testing capabilities method...
‚úì Capabilities: {'description': 'Sort DataFrame rows by one or multiple columns', 'supported_options': ['single_column_sort', 'multi_column_sort', 'custom_sort_orders', 'case_insensitive_sort', 'null_position_control', 'frequency_based_sort'], 'na_positions': ['first', 'last'], 'sort_directions': ['ascending', 'descending'], 'special_methods': ['sort_by_frequency', 'sort_by_custom_function', 'sort_by_multiple_criteria']}
‚úì Capabilities method worked correctly

Testing real-world scenario...
‚úì Created order data: 5 rows
‚úì Processed orders:
  ORD003: VIP $2500 (2024-01-16)
  ORD001: VIP $1500 (2024-01-15)
  ORD004: Premium $800 (2024-01-15)
  ORD005: Standard $400 (2024-01-13)
  ORD002: Standard $250 (2024-01-14)
‚úì Real-world scenario worked correctly

Testing error handling...
‚úì Caught expected error: Step 'Missing columns' missing required fields: columns
‚úì Caught expected error: Sort column 'NonExistentColumn' not found. Available columns: ['Product_Name', 'Price', 'Quantity', 'Priority', 'Department', 'Order_Date']
‚úì Caught expected error: Length of 'ascending' list (1) must match number of columns (2)

‚úì All sort data processor tests passed!

Processor Capabilities:
  description: Sort DataFrame rows by one or multiple columns
  supported_options: single_column_sort, multi_column_sort, custom_sort_orders, case_insensitive_sort, null_position_control, frequency_based_sort
  na_positions: first, last
  sort_directions: ascending, descending
  special_methods: sort_by_frequency, sort_by_custom_function, sort_by_multiple_criteria
Testing delimiter splitting...
‚úì Created test data: 5 rows
‚úì Delimiter split: 7 columns
‚úì New columns: ['Last_Name', 'First_Name']
‚úì Expected columns created
‚úì First record: 'Smith', 'John'
‚úì Delimiter splitting worked correctly

Testing pipe delimiter splitting...
‚úì Pipe split: 7 columns
‚úì All expected columns created
‚úì First product: 'A001' | 'Widget' | 'Electronics'
‚úì Pipe delimiter splitting worked correctly

Testing fixed width splitting...
‚úì Fixed width split: 8 columns
‚úì Fixed width columns created
‚úì First code split: 'ELEC' + '001' + 'A'
‚úì Fixed width splitting worked correctly

Testing regex splitting...
‚úì Regex split: 8 columns
‚úì Regex split columns created
‚úì First phone split: '206' - '555' - '1234'
‚úì Regex splitting worked correctly

Testing position splitting...
‚úì Position split: 8 columns
‚úì Position split columns created
‚úì Position split: 'ELEC' | '001' | 'A'
‚úì Position splitting worked correctly

Testing remove original option...
‚úì After split with remove: 6 columns
‚úì Original column removed, new columns added

Testing fill missing option...
‚úì Fill missing split: 4 columns
‚úì Part3 values: ['C', 'N/A', 'N/A', 'R']
‚úì Fill missing option worked correctly

Testing name splitting helper...
‚úì Last,First split: ['Customer_Name', 'Employee_Name', 'Last_Name', 'First_Name']
‚úì First Last split: ['Customer_Name', 'Employee_Name', 'First_Name', 'Last_Name']
‚úì Last,First result: 'Smith', 'John'
‚úì First Last result: 'John', 'Smith'
‚úì Name splitting helper worked correctly

Testing column analysis helper...
‚úì Name analysis suggestions: 4
‚úì Product analysis suggestions: 1
Name suggestions: ["Delimiter ',': avg 2.0 parts per value", "Delimiter ' ': avg 2.0 parts per value", 'Fixed width potential: avg length 13.2 chars', "Name pattern: 'Last, First' format detected"]
Product suggestions: ["Delimiter '|': avg 3.0 parts per value"]
‚úì Column analysis helper worked correctly

Testing auto column naming...
‚úì Auto naming result: 8 columns
‚úì Auto-generated columns: ['Product_Info_part_1', 'Product_Info_part_2', 'Product_Info_part_3']
‚úì Auto column naming worked correctly

Testing capabilities method...
‚úì Capabilities: dict_keys(['description', 'split_types', 'splitting_methods', 'helper_methods', 'common_delimiters', 'options', 'examples'])
‚úì Supported split types: ['delimiter', 'fixed_width', 'regex', 'position']
‚úì Capabilities method worked correctly

Testing real-world scenario...
‚úì Created real-world data: 4 records
‚úì Customer info split: 6 columns
‚úì Product details split: 7 columns
‚úì Order reference split: 11 columns
‚úì Final columns: ['Customer_Name', 'Email', 'Phone', 'Title', 'Product_Code', 'Product_Description', 'Order_Prefix', 'Year', 'Order_Number', 'Location', 'Priority']
Sample processed record:
  Customer: Smith, John
  Email: john.smith@email.com
  Product: ELEC-001-A -  Electronic Widget (Class A)
  Order: ORD-2024-001
  Location: SEA, Priority: RUSH
‚úì Real-world scenario worked correctly

Testing error handling...
‚úì Caught expected error: Step 'Missing fields' missing required fields: source_column, split_type
‚úì Caught expected error: Source column 'NonExistentColumn' not found. Available columns: ['Full_Name', 'Product_Info', 'Address', 'Product_Code', 'Phone']
‚úì Caught expected error: Delimiter split requires 'delimiter' field
‚úì Caught expected error: Invalid regex pattern '[invalid regex': unterminated character set at position 0

‚úì All split column processor tests passed!

Supported split types: ['delimiter', 'fixed_width', 'regex', 'position']
